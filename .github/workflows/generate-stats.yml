name: Generate Custom Profile Stats

on:
  schedule:
    - cron: "0 3 * * *"
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout repo
        uses: actions/checkout@v3

      - name: Install Node.js
        uses: actions/setup-node@v3
        with:
          node-version: 18

      - name: Create assets folder
        run: mkdir -p assets

      - name: Create and run script to generate SVG
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          cat << 'EOF' > script.js
          const fs = require('fs');

          const USER = "SimplyPowfu";
          const TOKEN = process.env.GITHUB_TOKEN;
          const headers = TOKEN ? { Authorization: `Bearer ${TOKEN}` } : {};

          async function getStats() {
            // -------- DATI BASE PROFILO --------
            const userRes = await fetch(`https://api.github.com/users/${USER}`, { headers });
            if (!userRes.ok) {
              console.error("Failed to fetch user:", await userRes.text());
              process.exit(1);
            }
            const user = await userRes.json();

            const reposRes = await fetch(
              `https://api.github.com/users/${USER}/repos?per_page=100`, 
              { headers }
            );
            
            if (!reposRes.ok) {
              console.error("Failed to fetch repos:", await reposRes.text());
              process.exit(1);
            }
            
            const repos = await reposRes.json();

            if (!Array.isArray(repos)) {
              console.error("Repos response is not an array:", repos);
              process.exit(1);
            }

            let totalStars = 0;
            let languageCount = {};

            repos.forEach(repo => {
              totalStars += repo.stargazers_count || 0;
              if (repo.language) {
                languageCount[repo.language] =
                  (languageCount[repo.language] || 0) + 1;
              }
            });

            const topLangs = Object.entries(languageCount)
              .sort((a, b) => b[1] - a[1])
              .slice(0, 3);

            const today = new Date().toLocaleDateString("it-IT");

            // ===================== STATS.SVG =====================
            const statsSvg = `
          <svg width="520" height="180" xmlns="http://www.w3.org/2000/svg">
            <rect width="520" height="180" rx="16" fill="#0A0F1F"/>
            <text x="25" y="40" fill="#4CAF50" font-size="22" font-weight="bold">
              SimplyPowfu ‚Äî GitHub Stats
            </text>
            <text x="25" y="75" fill="white" font-size="16">
              ‚Ä¢ Repo pubblici: ${user.public_repos}
            </text>
            <text x="25" y="100" fill="white" font-size="16">
              ‚Ä¢ Stelle totali: ${totalStars}
            </text>
            <text x="25" y="125" fill="white" font-size="16">
              ‚Ä¢ Followers: ${user.followers}
            </text>
            <text x="25" y="155" fill="#AAAAAA" font-size="12">
              Ultimo update: ${today}
            </text>
          </svg>
            `;
            fs.writeFileSync("assets/stats.svg", statsSvg);

            // ===================== TOP-LANGS.SVG =====================
            const bars = topLangs.map(([lang], i) => {
              const widths = [260, 200, 140];
              const yPositions = [70, 105, 140];

              return `
            <text x="20" y="${yPositions[i]}" fill="white" font-size="16">${lang}</text>
            <rect x="180" y="${yPositions[i] - 15}"
                  width="${widths[i]}" height="14" rx="7" fill="#4CAF50"/>
              `;
            }).join("\n");

            const topLangsSvg = `
          <svg width="520" height="200" xmlns="http://www.w3.org/2000/svg">
            <rect width="520" height="200" rx="16" fill="#0A0F1F"/>
            <text x="20" y="40" fill="#4CAF50" font-size="22">
              Top Languages ‚Äî SimplyPowfu
            </text>

            ${bars}

            <text x="20" y="180" fill="#AAAAAA" font-size="12">
              Aggiornato: ${today}
            </text>
          </svg>
            `;
            fs.writeFileSync("assets/top-langs.svg", topLangsSvg);

            // ===================== CARD PROGETTI =====================

            function projectCard(repoName, description, stars, language) {
              return `
          <svg width="520" height="140" xmlns="http://www.w3.org/2000/svg">
            <rect width="520" height="140" rx="16" fill="#0A0F1F"/>
            <text x="20" y="35" fill="#4CAF50" font-size="20">${repoName}</text>
            <text x="20" y="65" fill="white" font-size="14">${description}</text>
            <text x="20" y="95" fill="white" font-size="14">‚≠ê ${stars} stelle</text>
            <text x="20" y="115" fill="white" font-size="14">üõ†Ô∏è ${language || "N/A"}</text>
          </svg>
              `;
            }

            // Troviamo i tuoi due repo
            const repo42 = repos.find(r => r.name === "42CommonCore");
            const repoTrans = repos.find(r => r.name === "Transcendence");

            const card42 = projectCard(
              "42CommonCore",
              repo42?.description || "Progetti del Common Core di 42",
              repo42?.stargazers_count || 0,
              repo42?.language || "C"
            );

            const cardTrans = projectCard(
              "Transcendence",
              repoTrans?.description || "Progetto Web di 42",
              repoTrans?.stargazers_count || 0,
              repoTrans?.language || "TypeScript"
            );

            fs.writeFileSync("assets/42CommonCore.svg", card42);
            fs.writeFileSync("assets/Transcendence.svg", cardTrans);
          }

          getStats();
          EOF

          node script.js

      - name: Commit and push
        run: |
          git config --global user.name "github-bot"
          git config --global user.email "bot@github.com"
          git add assets/*.svg
          git commit -m "Update profile widgets" || echo "No changes"
          git push
